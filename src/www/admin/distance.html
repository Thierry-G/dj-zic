<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radar Display</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #121212;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        .radar-container {
            position: relative;
            width: 300px;
            height: 500px;
            overflow: visible;
        }

        .radar-viewport {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-origin: center;
            transition: transform 0.2s ease;
        }

        /* Device styling */
        .device {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            color: white;
        }

        .device-inner {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .device-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            box-shadow: 0 0 5px currentColor;
            position: relative;
            z-index: 2;
        }

        .device-range {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            opacity: 0.1;
            box-sizing: border-box;
            z-index: 1;
            border: 1px solid;
            background-color: transparent;
        }

        .device-label {
            font-size: 12px;
            line-height: 1.3;
            text-shadow: 0 0 3px black;
            white-space: nowrap;
            position: absolute;
            z-index: 3;
        }

        /* Master label below dot */
        #master .device-label {
            top: calc(100% + 5px);
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
        }

        /* Alternate label positioning for relays */
        .device-label.right {
            left: calc(100% + 10px);
            text-align: left;
        }

        .device-label.left {
            right: calc(100% + 10px);
            text-align: right;
        }

        .device-distance {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 2px;
        }

        /* Master device specific */
        #master {
            bottom: 50px;
        }

        #master .device-dot {
            width: 16px;
            height: 16px;
            background-color: #FF9800;
            box-shadow: 0 0 10px #FF9800;
        }

        /* Scale indicator */
        .scale-indicator {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: white;
            opacity: 0.7;
            z-index: 4;
        }

        /* Control buttons */
        .controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 8px;
            z-index: 4;
        }

        .control-btn {
            background-color: rgba(30, 30, 30, 0.9);
            color: white;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 12px;
            cursor: pointer;
        }

        .control-btn:hover {
            background-color: rgba(50, 50, 50, 0.9);
        }
    </style>
</head>
<body>
    <div class="radar-container">
        <div class="radar-viewport">
            <!-- Master device (origin point) -->
            <div class="device" id="master">
                <div class="device-inner">
                    <div class="device-range"></div>
                    <div class="device-dot"></div>
                    <div class="device-label">
                        dj-master<br>
                        10.1.0.1<br>
                        <span class="device-distance">0m</span>
                    </div>
                </div>
            </div>

            <!-- Relay devices will be added here dynamically -->
        </div>

        <!-- Scale indicator -->
        <div class="scale-indicator">1.0x</div>

        <!-- Control buttons -->
        <div class="controls">
            <button class="control-btn" id="zoom-out-btn">Zoom Out</button>
            <button class="control-btn" id="recenter-btn">Recenter</button>
            <button class="control-btn" id="zoom-in-btn">Zoom In</button>
        </div>
    </div>

    <script>
        // Configuration
        const config = {
            minZoom: 0.5,
            maxZoom: 2.0,
            defaultZoom: 1.0,
            zoomStep: 0.1,
            refreshInterval: 2000,
            pixelsPerMeter: 2,
            masterRange: 100 // 100m range for all devices
        };

        // State
        let currentZoom = config.defaultZoom;
        let devices = [];
        let maxDistance = 0;
        let viewport = document.querySelector('.radar-viewport');

        // Initialize radar
        function initRadar() {
            setupEventListeners();
            updateRadarData(); // Initial load
            setInterval(updateRadarData, config.refreshInterval);
        }

        // Create device element with alternating label positions
        function createDeviceElement(deviceData, color, index) {
            const element = document.createElement('div');
            element.className = 'device';
            element.id = deviceData.hostname || `device-${Math.random().toString(36).substr(2, 5)}`;
            
            // Position above master based on distance (origin at master)
            const positionFromBottom = 50 + (deviceData.distance * config.pixelsPerMeter);
            element.style.bottom = `${positionFromBottom}px`;
            
            // Alternate label position (right, left, right, etc.)
            const labelPosition = index % 2 === 0 ? 'right' : 'left';
            
            element.innerHTML = `
                <div class="device-inner">
                    <div class="device-range" style="
                        width: ${config.masterRange * config.pixelsPerMeter * 2}px;
                        height: ${config.masterRange * config.pixelsPerMeter * 2}px;
                        border-color: ${color};
                    "></div>
                    <div class="device-dot" style="background-color: ${color};"></div>
                    <div class="device-label ${labelPosition}">
                        ${deviceData.hostname || deviceData.type}<br>
                        ${deviceData.ip || 'N/A'}<br>
                        <span class="device-distance">${Math.round(deviceData.distance)}m</span>
                    </div>
                </div>
            `;
            
            return element;
        }

        // Update radar with data from JSON
        function updateRadarData() {
            fetch('data/distance.json')
                .then(response => response.json())
                .then(data => {
                    // Clear existing relays (keep master)
                    document.querySelectorAll('.device:not(#master)').forEach(el => el.remove());
                    
                    // Update master device
                    const masterRange = document.querySelector('#master .device-range');
                    masterRange.style.width = `${config.masterRange * config.pixelsPerMeter * 2}px`;
                    masterRange.style.height = `${config.masterRange * config.pixelsPerMeter * 2}px`;
                    masterRange.style.borderColor = '#FF9800';
                    
                    const masterLabel = document.querySelector('#master .device-label');
                    masterLabel.innerHTML = `
                        ${data.hostname}<br>
                        ${data.ip || '10.1.0.1'}<br>
                        <span class="device-distance">0m</span>
                    `;
                    
                    // Create relay devices
                    devices = [];
                    maxDistance = 0;
                    const colors = ['#2196F3', '#4CAF50', '#9C27B0', '#FF5252', '#FFEB3B', '#00BCD4'];
                    
                    Object.entries(data.devices).forEach(([hostname, deviceData], index) => {
                        const color = colors[index % colors.length];
                        const element = createDeviceElement({
                            ...deviceData,
                            hostname: hostname
                        }, color, index);
                        
                        document.querySelector('.radar-viewport').appendChild(element);
                        devices.push({
                            id: element.id,
                            distance: deviceData.distance,
                            color: color
                        });
                        
                        // Track maximum distance for viewport adjustment
                        const totalDeviceRange = deviceData.distance + config.masterRange;
                        if (totalDeviceRange > maxDistance) {
                            maxDistance = totalDeviceRange;
                        }
                    });
                    
                    updateViewportScale();
                })
                .catch(error => {
                    console.error("Error loading radar data:", error);
                });
        }

        // Update viewport scaling and position
        function updateViewportScale() {
            // Calculate required viewport height based on max distance
            const baseHeight = 50 + (maxDistance * config.pixelsPerMeter) + 100;
            const scaledHeight = baseHeight * currentZoom;
            
            // Calculate vertical offset to keep content centered
            const containerHeight = document.querySelector('.radar-container').clientHeight;
            let translateY = 0;
            
            if (scaledHeight > containerHeight) {
                // If content is taller than container, center it
                translateY = (containerHeight - scaledHeight) / 2;
            } else {
                // If content fits, keep master at bottom
                translateY = containerHeight - scaledHeight;
            }
            
            // Apply transform to viewport
            viewport.style.transform = `scale(${currentZoom}) translateY(${translateY}px)`;
            
            // Update scale indicator
            document.querySelector('.scale-indicator').textContent = `${currentZoom.toFixed(1)}x`;
        }

        // Zoom functionality
        function zoom(direction) {
            const newZoom = direction === 'in' 
                ? Math.min(currentZoom + config.zoomStep, config.maxZoom)
                : Math.max(currentZoom - config.zoomStep, config.minZoom);
            
            if (newZoom !== currentZoom) {
                currentZoom = newZoom;
                updateViewportScale();
            }
        }

        // Recenter functionality
        function recenter() {
            currentZoom = config.defaultZoom;
            updateViewportScale();
        }

        // Event listeners
        function setupEventListeners() {
            document.getElementById('zoom-in-btn').addEventListener('click', () => zoom('in'));
            document.getElementById('zoom-out-btn').addEventListener('click', () => zoom('out'));
            document.getElementById('recenter-btn').addEventListener('click', recenter);
            
            document.querySelector('.radar-container').addEventListener('wheel', (e) => {
                e.preventDefault();
                zoom(e.deltaY > 0 ? 'out' : 'in');
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', initRadar);
    </script>
</body>
</html>